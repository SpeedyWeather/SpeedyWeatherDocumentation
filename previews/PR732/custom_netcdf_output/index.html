<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>NetCDF output variables · SpeedyWeather.jl</title><meta name="title" content="NetCDF output variables · SpeedyWeather.jl"/><meta property="og:title" content="NetCDF output variables · SpeedyWeather.jl"/><meta property="twitter:title" content="NetCDF output variables · SpeedyWeather.jl"/><meta name="description" content="Documentation for SpeedyWeather.jl."/><meta property="og:description" content="Documentation for SpeedyWeather.jl."/><meta property="twitter:description" content="Documentation for SpeedyWeather.jl."/><meta property="og:url" content="https://speedyweather.github.io/SpeedyWeatherDocumentation/stable/custom_netcdf_output/"/><meta property="twitter:url" content="https://speedyweather.github.io/SpeedyWeatherDocumentation/stable/custom_netcdf_output/"/><link rel="canonical" href="https://speedyweather.github.io/SpeedyWeatherDocumentation/stable/custom_netcdf_output/"/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">SpeedyWeather.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../installation/">Installation</a></li><li><input class="collapse-toggle" id="menuitem-3" type="checkbox"/><label class="tocitem" for="menuitem-3"><span class="docs-label">Running SpeedyWeather</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../how_to_run_speedy/">How to run SpeedyWeather</a></li><li><a class="tocitem" href="../examples_2D/">Examples 2D</a></li><li><a class="tocitem" href="../examples_3D/">Examples 3D</a></li><li><a class="tocitem" href="../initial_conditions/">Initial conditions</a></li><li><a class="tocitem" href="../tracers/">Tracer advection</a></li><li><a class="tocitem" href="../particles/">Particle advection</a></li><li><a class="tocitem" href="../stochastic_physics/">Stochastic physics</a></li><li><a class="tocitem" href="../land/">Land surface model</a></li><li><a class="tocitem" href="../analysis/">Analysis</a></li><li><a class="tocitem" href="../structure/">Tree structure</a></li><li><a class="tocitem" href="../differentiability/">Differentiability and Adjoint Model</a></li><li><a class="tocitem" href="../output/">NetCDF output</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4" type="checkbox" checked/><label class="tocitem" for="menuitem-4"><span class="docs-label">Extending SpeedyWeather</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../extensions/">Extensions</a></li><li><a class="tocitem" href="../forcing_drag/">Forcing and drag</a></li><li><a class="tocitem" href="../parameterizations/">Parameterizations</a></li><li><a class="tocitem" href="../orography/">Orography</a></li><li><a class="tocitem" href="../land_sea_mask/">Land-Sea Mask</a></li><li><a class="tocitem" href="../ocean/">Ocean</a></li><li class="is-active"><a class="tocitem" href>NetCDF output variables</a><ul class="internal"><li><a class="tocitem" href="#New-output-variable"><span>New output variable</span></a></li><li><a class="tocitem" href="#Define-the-output-variable&#39;s-path"><span>Define the output variable&#39;s path</span></a></li><li><a class="tocitem" href="#Reading-the-new-variable"><span>Reading the new variable</span></a></li><li><a class="tocitem" href="#Change-units-before-output"><span>Change units before output</span></a></li><li><a class="tocitem" href="#Advanced:-Extend-the-output!-function"><span>Advanced: Extend the <code>output!</code> function</span></a></li></ul></li><li><a class="tocitem" href="../callbacks/">Callbacks</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5" type="checkbox"/><label class="tocitem" for="menuitem-5"><span class="docs-label">Dynamics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../barotropic/">Barotropic model</a></li><li><a class="tocitem" href="../shallowwater/">Shallow water model</a></li><li><a class="tocitem" href="../primitiveequation/">Primitive equation model</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-6" type="checkbox"/><label class="tocitem" for="menuitem-6"><span class="docs-label">Physics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../large_scale_condensation/">Large-scale condensation</a></li><li><a class="tocitem" href="../convection/">Convection</a></li><li><a class="tocitem" href="../radiation/">Radiation</a></li><li><a class="tocitem" href="../vertical_diffusion/">Vertical diffusion</a></li><li><a class="tocitem" href="../surface_fluxes/">Surface fluxes</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-7" type="checkbox"/><label class="tocitem" for="menuitem-7"><span class="docs-label">Discretization</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../spectral_transform/">Spherical Harmonic Transform</a></li><li><a class="tocitem" href="../grids/">Grids</a></li></ul></li><li><a class="tocitem" href="../ringgrids/">RingGrids</a></li><li><a class="tocitem" href="../lowertriangularmatrices/">LowerTriangularArrays</a></li><li><input class="collapse-toggle" id="menuitem-10" type="checkbox"/><label class="tocitem" for="menuitem-10"><span class="docs-label">SpeedyTransforms</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../speedytransforms/">Spectral transforms</a></li><li><a class="tocitem" href="../gradients/">Gradient operators</a></li></ul></li><li><a class="tocitem" href="../functions/">Function and type index</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Extending SpeedyWeather</a></li><li class="is-active"><a href>NetCDF output variables</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>NetCDF output variables</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/SpeedyWeather/SpeedyWeather.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/SpeedyWeather/SpeedyWeather.jl/blob/main/docs/src/custom_netcdf_output.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Customizing-netCDF-output"><a class="docs-heading-anchor" href="#Customizing-netCDF-output">Customizing netCDF output</a><a id="Customizing-netCDF-output-1"></a><a class="docs-heading-anchor-permalink" href="#Customizing-netCDF-output" title="Permalink"></a></h1><p>SpeedyWeather&#39;s <a href="../output/#NetCDF-output">NetCDF output</a> is modularised for the output variables, meaning you can add relatively easy new variables to be outputted alongside the default variables in the netCDF file. We explain here how to define a new output variable largely following the logic of <a href="../extensions/#Extending-SpeedyWeather">Extending SpeedyWeather</a>.</p><h2 id="New-output-variable"><a class="docs-heading-anchor" href="#New-output-variable">New output variable</a><a id="New-output-variable-1"></a><a class="docs-heading-anchor-permalink" href="#New-output-variable" title="Permalink"></a></h2><p>Say we want to output the <a href="../primitiveequation/#Vertical-velocity">Vertical velocity</a>. In <a href="../primitiveequation/#Sigma-coordinates">Sigma coordinates</a> on every time step, one has to integrate the divergence vertically to know where the flow is not divergence-free, meaning that the horizontally converging or diverging motion is balanced by a vertical velocity. This leads to the variable <span>$\partial \sigma / \partial t$</span>, which is the equivalent of <a href="../primitiveequation/#Vertical-velocity">Vertical velocity</a> in the <a href="../primitiveequation/#Sigma-coordinates">Sigma coordinates</a>. This variable is calculated and stored at every time step in </p><pre><code class="language-julia hljs">simulation.diagnostic_variables.dynamics.σ_tend</code></pre><p>So how do we access it and add it the netCDF output?</p><p>First we define <code>VerticalVelocityOutput</code> as a new <code>struct</code> subtype of <code>SpeedyWeather.AbstractOutputVariable</code> we add the required fields <code>name::String</code>, <code>unit::String</code>, <code>long_name::String</code> and <code>dims_xyzt::NTuple{4, Bool}</code> (we skip the optional fields for <code>missing_value</code> or compression).</p><pre><code class="language-julia hljs">using SpeedyWeather

@kwdef struct VerticalVelocityOutput &lt;: SpeedyWeather.AbstractOutputVariable
    name::String = &quot;w&quot;
    unit::String = &quot;s^-1&quot;
    long_name::String = &quot;vertical velocity dσ/dt&quot;
    dims_xyzt::NTuple{4, Bool} = (true, true, true, true)
end</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Main.VerticalVelocityOutput</code></pre><p><code>dims_xyzt</code> defines the dimensions of the output variable. By default (using the <code>@kwdef</code> macro) we set the dimensions in <code>dims_xyzt</code> to 4D with <code>(true, true, true, true)</code> because the vertical velocity is a 3D variable that we want to output on every time step. So while <code>dims_xyzt</code> is a required field for every output variable you should only change it if you want to output something else than a 4D variable. For a time series of a surface variable for example, we would need to set it to <code>(true, true, false, true)</code> to reflect the missing <code>z</code> dimension or for a constant field like the orography to <code>(true, true, false, false)</code>.</p><p>You can now add this variable to the <code>NetCDFOutput</code> as already described in <a href="../output/#Output-variables">Output variables</a></p><pre><code class="language-julia hljs">spectral_grid = SpectralGrid()
output = NetCDFOutput(spectral_grid)
add!(output, VerticalVelocityOutput())</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">NetCDFOutput{FullGaussianField{Float32, 1}}
├ status: inactive/uninitialized
├ write restart file: true (if active)
├ interpolator: AnvilInterpolator{Float32, SpeedyWeather.RingGrids.GridGeometry{OctahedralGaussianGrid{SpeedyWeather.RingGrids.DummyArchitecture, Vector{UnitRange{Int64}}, Vector{Int64}}, Vector{Float64}, Vector{Int64}}, SpeedyWeather.RingGrids.AnvilLocator{Float32, Vector{Float32}, Vector{Int64}}}
├ path: output.nc
├ frequency: 21600 seconds
└┐ variables:
 ├ w: vertical velocity dσ/dt [s^-1]
 ├ v: meridional wind [m/s]
 ├ u: zonal wind [m/s]
 └ vor: relative vorticity [s^-1]</code></pre><p>Note that here we skip the <code>SpeedyWeather.</code> prefix which would point to the SpeedyWeather scope but we have defined <code>VerticalVelocityOutput</code> in the global scope.</p><h2 id="Define-the-output-variable&#39;s-path"><a class="docs-heading-anchor" href="#Define-the-output-variable&#39;s-path">Define the output variable&#39;s path</a><a id="Define-the-output-variable&#39;s-path-1"></a><a class="docs-heading-anchor-permalink" href="#Define-the-output-variable&#39;s-path" title="Permalink"></a></h2><p>To output a variable one also has to define its path where to find the <code>AbstractField</code>. For our example we already said above that this is <code>simulation.diagnostic_variables.dynamics.σ_tend</code>. For this we need to extend the <code>path</code> function. Using multiple dispatch we need to constrain the first argument&#39;s type to <code>::VerticalVelocityOutput</code> but the second argument is just the simulation object.</p><pre><code class="language-julia hljs">SpeedyWeather.path(::VerticalVelocityOutput, simulation) =
    simulation.diagnostic_variables.dynamics.σ_tend</code></pre><h2 id="Reading-the-new-variable"><a class="docs-heading-anchor" href="#Reading-the-new-variable">Reading the new variable</a><a id="Reading-the-new-variable-1"></a><a class="docs-heading-anchor-permalink" href="#Reading-the-new-variable" title="Permalink"></a></h2><p>Now let&#39;s try this in a primitive dry model</p><pre><code class="language-julia hljs">model = PrimitiveDryModel(spectral_grid; output)
model.output.variables[:w]</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Main.VerticalVelocityOutput &lt;: SpeedyWeather.AbstractOutputVariable
├ name::String = w
├ unit::String = s^-1
├ long_name::String = vertical velocity dσ/dt
├ dims_xyzt::NTuple{4, Bool} = (true, true, true, true)</code></pre><p>By passing on <code>output</code> to the model constructor the output variables now contain <code>w</code> and we see it here as we have defined it earlier.</p><pre><code class="language-julia hljs">simulation = initialize!(model)
run!(simulation, period=Day(5), output=true)

# read netcdf data
using NCDatasets
path = joinpath(model.output.run_path, model.output.filename)
ds = NCDataset(path)
ds[&quot;w&quot;]</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi"><span class="sgr32">w</span> (96 × 48 × 8 × 21)
  Datatype:    <span class="sgr1">Union{Missing, Float32}</span> (Float32)
  Dimensions:  lon × lat × layer × time
  Attributes:
   units                = <span class="sgr36">s^-1</span>
   long_name            = <span class="sgr36">vertical velocity dσ/dt</span>
   _FillValue           = <span class="sgr36">NaN</span>
</code></pre><p>Fantastic, it&#39;s all there. We wrap this back into a <code>FullGaussianGrid</code> but ignore the mask (there are no masked values) in the netCDF file which causes a <code>Union{Missing, Float32}</code> element type by reading out the raw data with <code>.var</code>. And visualise the vertical velocity in sigma coordinates (remember this is actually <span>$\partial \sigma / \partial t$</span>) of the last time step (index <code>end</code>) stored on layer <span>$k=4$</span> (counted from the top)</p><pre><code class="language-julia hljs">w = FullGaussianGrid(ds[&quot;w&quot;].var[:, :, :, :], input_as=Matrix)

using CairoMakie
heatmap(w[:, 4, end], title=&quot;vertical velocity dσ/dt at k=4&quot;)</code></pre><p><img src="../sigma_tend.png" alt="Sigma tendency"/></p><p>This is now the vertical velocity between layer <span>$k=4$</span> and <span>$k=5$</span>. You can check that the vertical velocity on layer <span>$k=8$</span> is actually zero (because that is the boundary condition at the surface) and so would be the velocity between <span>$k=0$</span> and <span>$k=1$</span> at the top of the atmosphere, which however is not explicitly stored. The vertical velocity is strongest on the wind and leeward side of mountains which is reassuring and all the analysis we want to do here for now.</p><h2 id="Change-units-before-output"><a class="docs-heading-anchor" href="#Change-units-before-output">Change units before output</a><a id="Change-units-before-output-1"></a><a class="docs-heading-anchor-permalink" href="#Change-units-before-output" title="Permalink"></a></h2><p>In the definition of the output variable you can add a field called <code>transform</code> (not a spectral transform...) in order to automatically apply some element-wise post-processing. For example, you can use this to change the unit, e.g.</p><pre><code class="language-julia hljs">@kwdef struct MyVariableOutput &lt;: SpeedyWeather.AbstractOutputVariable
    name::String = &quot;a&quot;
    unit::String = &quot;mm&quot;
    long_name::String = &quot;my variable&quot;
    dims_xyzt::NTuple{4, Bool} = (true, true, true, true)
    transform::Function = (x) -&gt; 1000x
end</code></pre><p>would multiply every value by 1000 before writing to disk. If the variable inside SpeedyWeather has units of meters, this would convert to millimeters. You can also do <code>transform::Function = (x) -&gt; x - 273.15</code> to remove an offset (Kelvin to Celsius), or even <code>transform::Function = (x) -&gt; exp(x)/100</code> to convert from logarithm of Pascal to hecto Pascal (hPa). The <code>transform</code> function is applied element-wise to the array and is therefore implemented as an anonymous function of a single argument.</p><h2 id="Advanced:-Extend-the-output!-function"><a class="docs-heading-anchor" href="#Advanced:-Extend-the-output!-function">Advanced: Extend the <code>output!</code> function</a><a id="Advanced:-Extend-the-output!-function-1"></a><a class="docs-heading-anchor-permalink" href="#Advanced:-Extend-the-output!-function" title="Permalink"></a></h2><p>Defining the <code>path</code> as outlined in <a href="#Define-the-output-variable&#39;s-path">Define the output variable&#39;s path</a> will infer from the definition of the output variable how to write it into the netCDF file. As also outlined above this will automatically interpolate to the output grid and allows you to post-process with, e.g. a scale and offset, to change units from K to ˚C or m to mm.</p><p>If you want to have a lower level control about post-processing of a variable before it is written to disk you have to extend SpeedyWeather&#39;s <code>output!</code> function with the following function signature</p><pre><code class="language-julia hljs">function SpeedyWeather.output!(
    output::NetCDFOutput,
    variable::VerticalVelocityOutput,
    simulation::SpeedyWeather.AbstractSimulation,
)
    # INTERPOLATION
    w = output.grid3D               # scratch grid to interpolate into
    (; σ_tend) = simulation.diagnostic_variables.dynamics     # point to data in diagnostic variables
    RingGrids.interpolate!(w, σ_tend , output.interpolator)

    # (do any changes to w here)

    # WRITE TO NETCDF
    i = output.output_counter       # output time step to write
    output.netcdf_file[variable.name][:, :, :, i] = w
    return nothing
end</code></pre><p>The first argument has to be <code>::NetCDFOutput</code> as this is the argument we write into (i.e. mutate). The second argument has to be <code>::VerticalVelocityOutput</code> so that Julia&#39;s multiple dispatch calls this <code>output!</code> method for our new variable. Then the simulation allows us generally to read any data and use it to write into the netCDF file.</p><p>In most cases you will need to interpolate any gridded variables inside the model (which can be on a reduced grd) onto the output grid (which has to be a full grid, see <a href="../output/#Output-grid">Output grid</a>). For that the <code>NetCDFOutput</code> has two scratch arrays <code>grid3D</code> and <code>grid2D</code> which are of type and size as defined by the <code>output_Grid</code> and <code>nlat_half</code> arguments when creating the <code>NetCDFOutput</code>. So the three lines for interpolation are essentially those in which your definition of a new output variable is linked with where to find that variable in <code>diagnostic_variables</code>. You can, in principle, also do any kind of computation here, for example adding two variables, normalising data and so on. In the end it has to be on the <code>output_Grid</code> hence you probably do not want to skip the interpolation step but you are generally allowed to do much more here before or after the interpolation.</p><p>The last two lines are then just about actually writing to netcdf. For any variable that is written on every output time step you can use the output counter <code>i</code> to point to the correct index <code>i</code> in the netcdf file as shown here. For 2D variables (horizontal+time) the indexing would be <code>[:, :, i]</code>. 2D variables without time you only want to write once (because they do not change) the indexing would change to <code>[:, :]</code> and you then probably want to add a line at the top like <code>output.output_counter &gt; 1 || return nothing</code> to escape immediately after the first output time step. But you could also check for a specific condition (e.g. a new temperature record in a given location) and only then write to netcdf. Just some ideas how to customize this even further.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../ocean/">« Ocean</a><a class="docs-footer-nextpage" href="../callbacks/">Callbacks »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.12.0 on <span class="colophon-date" title="Wednesday 18 June 2025 11:35">Wednesday 18 June 2025</span>. Using Julia version 1.11.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
