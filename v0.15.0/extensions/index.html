<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Extensions · SpeedyWeather.jl</title><meta name="title" content="Extensions · SpeedyWeather.jl"/><meta property="og:title" content="Extensions · SpeedyWeather.jl"/><meta property="twitter:title" content="Extensions · SpeedyWeather.jl"/><meta name="description" content="Documentation for SpeedyWeather.jl."/><meta property="og:description" content="Documentation for SpeedyWeather.jl."/><meta property="twitter:description" content="Documentation for SpeedyWeather.jl."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">SpeedyWeather.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../installation/">Installation</a></li><li><input class="collapse-toggle" id="menuitem-3" type="checkbox"/><label class="tocitem" for="menuitem-3"><span class="docs-label">Running SpeedyWeather</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../how_to_run_speedy/">How to run SpeedyWeather</a></li><li><a class="tocitem" href="../examples_2D/">Examples 2D</a></li><li><a class="tocitem" href="../examples_3D/">Examples 3D</a></li><li><a class="tocitem" href="../initial_conditions/">Initial conditions</a></li><li><a class="tocitem" href="../tracers/">Tracer advection</a></li><li><a class="tocitem" href="../particles/">Particle advection</a></li><li><a class="tocitem" href="../stochastic_physics/">Stochastic physics</a></li><li><a class="tocitem" href="../land/">Land surface model</a></li><li><a class="tocitem" href="../analysis/">Analysis</a></li><li><a class="tocitem" href="../structure/">Tree structure</a></li><li><a class="tocitem" href="../differentiability/">Differentiability and Adjoint Model</a></li><li><a class="tocitem" href="../output/">NetCDF output</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4" type="checkbox" checked/><label class="tocitem" for="menuitem-4"><span class="docs-label">Extending SpeedyWeather</span><i class="docs-chevron"></i></label><ul class="collapsed"><li class="is-active"><a class="tocitem" href>Extensions</a><ul class="internal"><li><a class="tocitem" href="#logic"><span>SpeedyWeather&#39;s modular logic</span></a></li><li><a class="tocitem" href="#Scope-of-variables"><span>Scope of variables</span></a></li><li><a class="tocitem" href="#Abstract-model-components"><span>Abstract model components</span></a></li></ul></li><li><a class="tocitem" href="../forcing_drag/">Forcing and drag</a></li><li><a class="tocitem" href="../parameterizations/">Parameterizations</a></li><li><a class="tocitem" href="../orography/">Orography</a></li><li><a class="tocitem" href="../land_sea_mask/">Land-Sea Mask</a></li><li><a class="tocitem" href="../ocean/">Ocean</a></li><li><a class="tocitem" href="../custom_netcdf_output/">NetCDF output variables</a></li><li><a class="tocitem" href="../callbacks/">Callbacks</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5" type="checkbox"/><label class="tocitem" for="menuitem-5"><span class="docs-label">Dynamics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../barotropic/">Barotropic model</a></li><li><a class="tocitem" href="../shallowwater/">Shallow water model</a></li><li><a class="tocitem" href="../primitiveequation/">Primitive equation model</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-6" type="checkbox"/><label class="tocitem" for="menuitem-6"><span class="docs-label">Physics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../large_scale_condensation/">Large-scale condensation</a></li><li><a class="tocitem" href="../convection/">Convection</a></li><li><a class="tocitem" href="../radiation/">Radiation</a></li><li><a class="tocitem" href="../vertical_diffusion/">Vertical diffusion</a></li><li><a class="tocitem" href="../surface_fluxes/">Surface fluxes</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-7" type="checkbox"/><label class="tocitem" for="menuitem-7"><span class="docs-label">Discretization</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../spectral_transform/">Spherical Harmonic Transform</a></li><li><a class="tocitem" href="../grids/">Grids</a></li></ul></li><li><a class="tocitem" href="../ringgrids/">RingGrids</a></li><li><a class="tocitem" href="../lowertriangularmatrices/">LowerTriangularMatrices</a></li><li><input class="collapse-toggle" id="menuitem-10" type="checkbox"/><label class="tocitem" for="menuitem-10"><span class="docs-label">SpeedyTransforms</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../speedytransforms/">Spectral transforms</a></li><li><a class="tocitem" href="../gradients/">Gradient operators</a></li></ul></li><li><a class="tocitem" href="../functions/">Function and type index</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Extending SpeedyWeather</a></li><li class="is-active"><a href>Extensions</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Extensions</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/SpeedyWeather/SpeedyWeather.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/SpeedyWeather/SpeedyWeather.jl/blob/main/docs/src/extensions.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Extending-SpeedyWeather"><a class="docs-heading-anchor" href="#Extending-SpeedyWeather">Extending SpeedyWeather</a><a id="Extending-SpeedyWeather-1"></a><a class="docs-heading-anchor-permalink" href="#Extending-SpeedyWeather" title="Permalink"></a></h1><p>Generally, SpeedyWeather is built in a very modular, extensible way. While that sounds fantastic in general, it does not save you from understanding its <a href="#logic">modular logic</a> before you can extend SpeedyWeather.jl easily yourself. We highly recommend you to read the following sections if you would like to extend SpeedyWeather in some way, but it also gives you a good understanding of how we build SpeedyWeather in the first place. Because in the end there is no difference between internally or externally defined model components. Having said that, there is a question of the <a href="#Scope-of-variables">Scope of variables</a> meaning that some functions or types require its module to be explicitly named, like <code>SpeedyWeather.some_function</code> instead of just <code>some_function</code>. But that&#39;s really it.</p><p>Before and especially after reading this section you are welcome to <a href="https://github.com/SpeedyWeather/SpeedyWeather.jl/issues">raise an issue</a> about whatever you would like to do with SpeedyWeather. We are happy to help.</p><h2 id="logic"><a class="docs-heading-anchor" href="#logic">SpeedyWeather&#39;s modular logic</a><a id="logic-1"></a><a class="docs-heading-anchor-permalink" href="#logic" title="Permalink"></a></h2><p>Almost every component in SpeedyWeather is implemented in three steps:</p><ol><li>Define a new type,</li><li>define its initialization,</li><li>extend a function that defines what it does.</li></ol><p>To be a bit more explicit (Julia always encourages you to think more abstractly, which can be difficult to get started...) we will use the example of defining a new forcing for the <code>Barotropic</code> or <code>ShallowWater</code> models. But the concept is the same whether you want to define a forcing, a drag, or a new parameterization for the primitive equations, etc. For the latter, see <a href="../parameterizations/#Parameterizations">Parameterizations</a> In general, you can define a new component also just in a notebook or in the Julia REPL, you do not have to branch off from the repository and write directly into it. However, note the <a href="#Scope-of-variables">Scope of variables</a> if you define a component externally.</p><p>To define a new forcing type, at the most basic level you would do</p><pre><code class="language-julia hljs">using SpeedyWeather

struct MyForcing{NF} &lt;: SpeedyWeather.AbstractForcing
    # define some parameters and work arrays here
    a::NF
    v::Vector{NF}
end</code></pre><p>In Julia this introduces a new (so-called compound) type that is a subtype of <code>AbstractForcing</code>, we have a bunch of these abstract super types defined (see <a href="#Abstract-model-components">Abstract model components</a>) and you want to piggy-back on them because of multiple-dispatch. This new type could also be  a <code>mutable struct</code>, could have keywords defined with <code>@kwdef</code> and can also be parametric with respect to the number format <code>NF</code> or grid, but let&#39;s skip those details for now. Conceptually you include into the type any parameters (example the float <code>a</code> here) that you may need and especially those that you want to change (ideally not work arrays, see discussion in <a href="../parameterizations/#Use-ColumnVariables-work-arrays">Use <code>ColumnVariables</code> work arrays</a>). This type will get a user-facing interface so that one can quickly create a new forcing but with altered parameters. Generally you should also include any kind of precomputed arrays (here a vector <code>v</code>). For example, you want to apply your forcing only in certain parts of the globe? Then you probably want to define a mask here that somehow includes the information of your region. For a more concrete example see <a href="../forcing_drag/#Custom-forcing-and-drag">Custom forcing and drag</a>.</p><p>To define the new type&#39;s initialization, at the most basic level you need to extend the <code>initialize!</code> function for this new type. A dummy example:</p><pre><code class="language-julia hljs">function initialize!(forcing::MyForcing, model::AbstractModel)
    # fill in/change any fields of your new forcing here
    forcing.v[1] = 1
    # you can use information from other model components too
    forcing.v[2] = model.planet.gravity
end</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">initialize! (generic function with 1 method)</code></pre><p>This function is called <em>once</em> during model initialisation (which is in fact just the initialisation of all its components, like the forcing here) and it allows you to precompute values or arrays also based on parameters of other model components. Like in this example, we want to use the gravity that is defined in <code>model.planet</code>. If you need a value for gravity in your forcing you could add a gravity field therein, but then if you change <code>planet.gravity</code> this change would not propagate into your forcing! Another example would be to use <code>model.geometry.coslat</code> if you need to use the cosine of latitude for some precomputation, which, however, depends on the resolution and so should not be hardcoded into your forcing.</p><p>As the last step we have to extend the <code>forcing!</code> function which is the function that is called on <em>every</em> step of the time integration. This new method for <code>forcing!</code> needs to have the following function signature</p><pre><code class="language-julia hljs">function forcing!(
    diagn::DiagnosticVariables,
    progn::PrognosticVariables,
    forcing::MyForcing,
    model::AbstractModel,
    lf::Integer,
)
    # whatever the forcing is supposed to do, in the end you want
    # to write into the tendency fields
    diagn.tendencies.u_tend_grid = forcing.a
    diagn.tendencies.v_tend_grid = forcing.a
    diagn.tendencies.vor_tend = forcing.a
end</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">forcing! (generic function with 1 method)</code></pre><p><code>DiagnosticVariables</code> is the type of the first argument, because it contains the tendencies you will want to change, so this is supposed to be read and write. The other arguments should be treated read-only. You can make use of anything else in <code>model</code>, but often we unpack the model in a function barrier (which can help with type inference and therefore performance). But let&#39;s skip that detail for now. Generally, try to precompute what you can in <code>initialize!</code>. For the forcing you will need to force the velocities <code>u, v</code> in grid-point space or the vorticity <code>vor</code>, divergence <code>div</code> in spectral space. This is not a constrain in most applications we came across, but in case it is in yours please reach out.</p><h2 id="Scope-of-variables"><a class="docs-heading-anchor" href="#Scope-of-variables">Scope of variables</a><a id="Scope-of-variables-1"></a><a class="docs-heading-anchor-permalink" href="#Scope-of-variables" title="Permalink"></a></h2><p>The above (conceptual!) examples leave out some of the details, particularly around the scope of variables when you want to define a new forcing interactively inside a notebook or the REPL (which is actually the recommended way!!). To respect the scope of variables, a bunch of functions will need their module to be explicit specified. In general, you should be familiar with Julia&#39;s  <a href="https://docs.julialang.org/en/v1/manual/variables-and-scoping/">scope of variables</a> logic.</p><p>The <code>initialize!</code> function is a function <em>inside</em> the SpeedyWeather module, as we want to define a new method for it <em>outside</em> that can be called <em>inside</em> we actually need to write</p><pre><code class="language-julia hljs">function SpeedyWeather.initialize!(forcing::MyForcing, model::SpeedyWeather.AbstractModel)
    # how to initialize it
end</code></pre><p>And similar for <code>SpeedyWeather.forcing!</code>.</p><p>You also probably want to make use of functions that are already defined inside SpeedyWeather or its submodules <code>SpeedyTransforms</code>, or <code>RingGrids</code>. If something does not seem to be defined, although you can see it in the documentation or directly in the code, you probably need to specify its module too! Alternatively, note that you can also always do <code>import SpeedWeather: AbstractModel</code> to bring a given variable into global scope which removes the necessity to write <code>SpeedyWeather.AbstractModel</code>.</p><h2 id="Abstract-model-components"><a class="docs-heading-anchor" href="#Abstract-model-components">Abstract model components</a><a id="Abstract-model-components-1"></a><a class="docs-heading-anchor-permalink" href="#Abstract-model-components" title="Permalink"></a></h2><p>You may wonder which abstract model components there are, you can always check this with</p><pre><code class="language-julia hljs">subtypes(SpeedyWeather.AbstractModelComponent)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">22-element Vector{Any}:
 SpeedyWeather.AbstractAdiabaticConversion
 SpeedyWeather.AbstractAlbedo
 SpeedyWeather.AbstractAtmosphere
 SpeedyWeather.AbstractCoriolis
 SpeedyWeather.AbstractDrag
 SpeedyWeather.AbstractForcing
 SpeedyWeather.AbstractGeopotential
 SpeedyWeather.AbstractHorizontalDiffusion
 SpeedyWeather.AbstractImplicit
 SpeedyWeather.AbstractInitialConditions
 ⋮
 SpeedyWeather.AbstractOrography
 SpeedyWeather.AbstractOutput
 SpeedyWeather.AbstractParameterization
 SpeedyWeather.AbstractParticleAdvection
 SpeedyWeather.AbstractPlanet
 SpeedyWeather.AbstractRandomProcess
 SpeedyWeather.AbstractSchedule
 SpeedyWeather.AbstractTimeStepper
 SpeedyWeather.AbstractTracer</code></pre><p>we illustrated the modular logic here using <code>AbstractForcing</code> and <code>AbstractDrag</code> is very similar. However, other model components also largely follow <a href="#logic">SpeedyWeather&#39;s modular logic</a> as for example outlined in <a href="../callbacks/#Defining-a-callback">Defining a callback</a> or  <a href="../orography/#Defining-a-new-orography-type">Defining a new orography type</a>. If you do not find much documentation about a new custom type where you would like extend SpeedyWeather&#39;s functionality it is probably because we have not experimented much with this either. But that does not mean it is not possible. Just reach out by creating an issue in this case.</p><p>Similarly, <code>AbstractParameterization</code> has several subtypes that define conceptual classes of parameterizations, namely</p><pre><code class="language-julia hljs">subtypes(SpeedyWeather.AbstractParameterization)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">18-element Vector{Any}:
 SpeedyWeather.AbstractBoundaryLayer
 SpeedyWeather.AbstractClausiusClapeyron
 SpeedyWeather.AbstractCondensation
 SpeedyWeather.AbstractConvection
 SpeedyWeather.AbstractLandTemperature
 SpeedyWeather.AbstractOpticalDepth
 SpeedyWeather.AbstractRadiation
 SpeedyWeather.AbstractRivers
 SpeedyWeather.AbstractSoilMoisture
 SpeedyWeather.AbstractStochasticPhysics
 SpeedyWeather.AbstractSurfaceEvaporation
 SpeedyWeather.AbstractSurfaceHeatFlux
 SpeedyWeather.AbstractSurfacePerturbation
 SpeedyWeather.AbstractSurfaceThermodynamics
 SpeedyWeather.AbstractSurfaceWind
 SpeedyWeather.AbstractTemperatureRelaxation
 SpeedyWeather.AbstractVegetation
 SpeedyWeather.AbstractVerticalDiffusion</code></pre><p>but these are discussed in more detail in <a href="../parameterizations/#Parameterizations">Parameterizations</a>. For a more concrete example of how to define a new forcing for the 2D models, see <a href="../forcing_drag/#Custom-forcing-and-drag">Custom forcing and drag</a>.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../output/">« NetCDF output</a><a class="docs-footer-nextpage" href="../forcing_drag/">Forcing and drag »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.10.2 on <span class="colophon-date" title="Monday 28 April 2025 09:38">Monday 28 April 2025</span>. Using Julia version 1.11.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
